!function(a){Craft.UpdateInfo=Garnish.Base.extend({appUpdateInfo:null,$container:null,$downloadBtn:null,licenseHud:null,$licenseSubmitBtn:null,licenseSubmitAction:null,allowAutoUpdates:null,init:function(){var b=a("#graphic"),c=a("#status");Craft.postActionRequest("update/get-available-updates",a.proxy(function(d,e){if("success"!=e||d.error||d.errors){var f=Craft.t("An unknown error occurred.");d.errors&&d.errors.length?f=d.errors[0]:d.error&&(f=d.error),b.addClass("error"),c.text(f)}else{var g={total:d.app&&d.app.releases&&d.app.releases.length?1:0,critical:d.app&&d.criticalUpdateAvailable};g.total?(b.velocity("fadeOut",{duration:"fast"}),c.fadeOut("fast",a.proxy(function(){b.remove(),c.remove(),this.appUpdateInfo=d.app,this.allowAutoUpdates=d.allowAutoUpdates,this.showAvailableUpdates()},this))):(b.addClass("success"),c.text(Craft.t("You’re all up-to-date!"))),Craft.cp.displayUpdateInfo(g)}},this))},showAvailableUpdates:function(){this.$container=a("<div/>").appendTo(Craft.cp.$main).hide();var b,c=a('<div class="pane clearafter"/>').appendTo(this.$container),d=(a('<h2 class="heading">'+Craft.t("You’ve got updates!")+"</h2>").appendTo(c),a('<div class="buttons"/>').appendTo(c)),e=!this.allowAutoUpdates||this.appUpdateInfo.manualUpdateRequired;if(e)this.$downloadBtn=a('<div class="btn submit">'+Craft.t("Download")+"</div>").appendTo(d);else{var f=a('<div class="btngroup submit"/>').appendTo(d);b=a('<div class="btn submit">'+Craft.t("Update")+"</div>").appendTo(f);var g=a('<div class="btn submit menubtn"/>').appendTo(f),h=a('<div class="menu" data-align="right"/>').appendTo(f),i=a("<ul/>").appendTo(h),j=a("<li/>").appendTo(i);this.$downloadBtn=a("<a>"+Craft.t("Download")+"</a>").appendTo(j),new Garnish.MenuBtn(g)}this.appUpdateInfo.licenseUpdated?(this.addListener(this.$downloadBtn,"click","showLicenseForm"),e||this.addListener(b,"click","showLicenseForm")):(this.addListener(this.$downloadBtn,"click","downloadThat"),e||this.addListener(b,"click","autoUpdateThat")),this.showReleases(this.appUpdateInfo.releases,"Craft"),this.$container.velocity("fadeIn",{duration:"fast"})},showLicenseForm:function(b){if(b.stopPropagation(),this.licenseHud)this.licenseHud.$trigger=a(b.currentTarget),this.licenseHud.show();else{var c=a("<form><p>"+Craft.t('Craft’s <a href="http://buildwithcraft.com/license" target="_blank">Terms and Conditions</a> have changed.')+"</p></form>"),d=a("<label> "+Craft.t("I agree.")+" &nbsp;</label>").appendTo(c),e=a('<input type="checkbox"/>').prependTo(d);this.$licenseSubmitBtn=a('<input class="btn submit" type="submit"/>').appendTo(c),this.licenseHud=new Garnish.HUD(b.currentTarget,c),this.addListener(c,"submit",function(a){a.preventDefault(),e.prop("checked")?(this.licenseSubmitAction(),this.licenseHud.hide(),e.prop("checked",!1)):Garnish.shake(this.licenseHud.$hud)})}b.currentTarget==this.$downloadBtn[0]?(this.$licenseSubmitBtn.attr("value",Craft.t("Seriously, download.")),this.licenseSubmitAction=this.downloadThat):(this.$licenseSubmitBtn.attr("value",Craft.t("Seriously, update.")),this.licenseSubmitAction=this.autoUpdateThat)},showReleases:function(b,c){for(var d=0;d<b.length;d++){var e=a('<div class="pane release"/>').appendTo(this.$container),f=b[d],g=c+" "+f.version;f.build&&(g+=' <span class="light">'+Craft.t("build {build}",{build:f.build})+"</span>"),f.critical&&(g+=' <span class="critical">'+Craft.t("Critical")+"</span>"),a("<h2>"+g+"</h2>").appendTo(e),a('<div class="notes"/>').appendTo(e).html(f.notes)}},downloadThat:function(){var b=this.appUpdateInfo.manualDownloadEndpoint;"https:"==window.location.protocol&&(b=b.replace("http:","https:")),a("<iframe/>",{src:b}).appendTo(Garnish.$bod).hide()},autoUpdateThat:function(){window.location.href=Craft.getUrl("updates/go/craft")}})}(jQuery);
//# sourceMappingURL=updates.js.map